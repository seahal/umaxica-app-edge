name: "umaxica-net"

services:
  dev:
    build:
      context: ..
      dockerfile: Dockerfile
      target: development
      args:
        - DOCKER_UID=${UID:-1000}
        - DOCKER_GID=${GID:-1000}
        - DOCKER_USER=apex
        - DOCKER_GROUP=group
    working_dir: /home/apex/workspace/net
    volumes:
      - type: bind
        source: ..
        target: /home/apex/workspace
        consistency: cached
      - type: volume
        source: node-modules
        target: /home/apex/workspace/net/node_modules
        volume:
          nocopy: true
      - type: volume
        source: bun-cache
        target: /home/apex/.bun
        volume:
          nocopy: true
    ports:
      - "5173:5173"
      - "5174:5174"
      - "8787:8787"
    environment:
      - NODE_ENV=development
      - NODE_OPTIONS=--max-old-space-size=4096
    command: bun run server
    tty: true
    stdin_open: true
    init: true
    user: apex:group
    restart: unless-stopped

  build:
    build:
      context: ..
      dockerfile: Dockerfile
      target: development
      args:
        - DOCKER_UID=${UID:-1000}
        - DOCKER_GID=${GID:-1000}
        - DOCKER_USER=apex
        - DOCKER_GROUP=group
    working_dir: /home/apex/workspace/net
    volumes:
      - type: bind
        source: ..
        target: /home/apex/workspace
        consistency: cached
      - type: volume
        source: node-modules
        target: /home/apex/workspace/net/node_modules
        volume:
          nocopy: true
      - type: volume
        source: bun-cache
        target: /home/apex/.bun
        volume:
          nocopy: true
    environment:
      - NODE_ENV=production
    command: bun run build
    user: apex:group
    profiles:
      - build

  wrangler:
    build:
      context: ..
      dockerfile: Dockerfile
      target: development
      args:
        - DOCKER_UID=${UID:-1000}
        - DOCKER_GID=${GID:-1000}
        - DOCKER_USER=apex
        - DOCKER_GROUP=group
    working_dir: /home/apex/workspace/net
    volumes:
      - type: bind
        source: ..
        target: /home/apex/workspace
        consistency: cached
      - type: volume
        source: node-modules
        target: /home/apex/workspace/net/node_modules
        volume:
          nocopy: true
      - type: volume
        source: bun-cache
        target: /home/apex/.bun
        volume:
          nocopy: true
    ports:
      - "8787:8787"
    environment:
      - NODE_ENV=development
    command: bunx wrangler dev --ip 0.0.0.0 --port 8787
    tty: true
    stdin_open: true
    init: true
    user: apex:group
    restart: unless-stopped
    profiles:
      - wrangler

volumes:
  node-modules:
    driver: local
  bun-cache:
    driver: local
